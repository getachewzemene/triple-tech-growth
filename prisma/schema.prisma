// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum EnrollmentStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum PaymentProofStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContentType {
  VIDEO
  PDF
  QUIZ
  ASSIGNMENT
}

enum InstructorApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CourseVisibility {
  DRAFT
  PUBLISHED
  UNLISTED
}

enum ConversationType {
  DIRECT
  GROUP
  COURSE
}

model Course {
  id              String           @id @default(cuid())
  slug            String           @unique
  title           String
  description     String
  priceCents      Int
  thumbnailKey    String?
  isPublished     Boolean          @default(false)
  visibility      CourseVisibility @default(DRAFT)
  category        String?
  // Legacy fields for backward compatibility
  detail          String?
  instructor      String?
  instructorId    String?          // Reference to instructor user
  s3Key           String?          // S3 object key for the video file
  videoUrl        String?          // Optional CDN URL for the video
  duration        Int?             // Duration in seconds
  size            Int?             // File size in bytes
  isProtected     Boolean          @default(true) // Whether DRM/encryption is enabled
  drmEnabled      Boolean          @default(false) // Whether DRM is specifically enabled
  transcodeStatus String           @default("pending") // pending, processing, completed, failed
  enableDiscussion Boolean         @default(true) // Enable discussion forum
  enableCertificate Boolean        @default(true) // Enable certificate on completion
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       String           // User ID who created the course
  
  // Relations for enrollment tracking
  lessons          Lesson[]
  enrollments      Enrollment[]
  paymentProofs    PaymentProof[]
  playbackSessions PlaybackSession[]
  discussions      Discussion[]
  reviews          CourseReview[]
  certificates     Certificate[]
  conversations    Conversation[]
  announcements    CourseAnnouncement[]
  instructorUser   User?            @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: SetNull)
  
  @@map("courses")
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  status    EnrollmentStatus @default(PENDING) // pending, active, rejected
  createdAt DateTime @default(now())
  approvedAt DateTime?
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

model PlaybackSession {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  sessionId   String   @unique
  userAgent   String?
  ipAddress   String?
  startedAt   DateTime @default(now())
  lastActiveAt DateTime @default(now())
  isActive    Boolean  @default(true)
  
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("playback_sessions")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  role        UserRole @default(STUDENT)
  isAdmin     Boolean  @default(false)
  avatarUrl   String?
  bio         String?
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  enrollments              Enrollment[]
  paymentProofs            PaymentProof[]
  instructorProfile        InstructorProfile?
  instructorCourses        Course[]              @relation("InstructorCourses")
  discussions              Discussion[]
  discussionReplies        DiscussionReply[]
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]
  reviews                  CourseReview[]
  certificates             Certificate[]
  notifications            Notification[]
  lessonProgress           LessonProgress[]
  
  @@map("users")
}

model Lesson {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  description String?
  contentType ContentType
  s3Key       String?
  videoUrl    String?          // For external video URLs (YouTube, etc)
  content     String?          @db.Text // For text-based content
  duration    Int?             // Duration in seconds for videos
  order       Int
  isFree      Boolean          @default(false) // Free preview lesson
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]
  
  @@index([courseId])
  @@map("lessons")
}

model PaymentProof {
  id         String            @id @default(cuid())
  userId     String
  courseId   String
  s3Key      String
  status     PaymentProofStatus @default(PENDING)
  comment    String?
  uploadedAt DateTime          @default(now())
  reviewedAt DateTime?
  
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("payment_proofs")
}

model AdminNotification {
  id        String   @id @default(cuid())
  type      String
  payload   String   // JSON string
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@map("admin_notifications")
}

// ==========================================
// Instructor Features
// ==========================================

model InstructorProfile {
  id                String                      @id @default(cuid())
  userId            String                      @unique
  bio               String?
  expertise         String[]
  profileImage      String?
  qualifications    String?
  socialLinks       Json?                       // { linkedin, twitter, website, etc }
  bankDetails       Json?                       // For payment disbursement
  applicationStatus InstructorApplicationStatus @default(PENDING)
  applicationNote   String?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  totalStudents     Int                         @default(0)
  totalCourses      Int                         @default(0)
  totalEarnings     Int                         @default(0) // In cents
  averageRating     Float                       @default(0)
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  
  user              User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("instructor_profiles")
}

// ==========================================
// Discussion Forum
// ==========================================

model Discussion {
  id          String   @id @default(cuid())
  courseId    String
  authorId    String
  title       String
  content     String   @db.Text
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  upvotes     Int      @default(0)
  viewCount   Int      @default(0)
  replyCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  course      Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author      User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  replies     DiscussionReply[]
  
  @@index([courseId])
  @@index([authorId])
  @@map("discussions")
}

model DiscussionReply {
  id            String   @id @default(cuid())
  discussionId  String
  authorId      String
  parentId      String?  // For nested replies
  content       String   @db.Text
  isBestAnswer  Boolean  @default(false)
  upvotes       Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  discussion    Discussion        @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  author        User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent        DiscussionReply?  @relation("ReplyToReply", fields: [parentId], references: [id], onDelete: SetNull)
  children      DiscussionReply[] @relation("ReplyToReply")
  
  @@index([discussionId])
  @@index([authorId])
  @@map("discussion_replies")
}

// ==========================================
// Chat & Messaging System
// ==========================================

model Conversation {
  id            String           @id @default(cuid())
  type          ConversationType @default(DIRECT)
  name          String?          // For group chats
  courseId      String?          // For course-based groups
  avatarUrl     String?
  lastMessageAt DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  course        Course?                    @relation(fields: [courseId], references: [id], onDelete: SetNull)
  participants  ConversationParticipant[]
  messages      Message[]
  
  @@index([courseId])
  @@map("conversations")
}

model ConversationParticipant {
  id              String    @id @default(cuid())
  conversationId  String
  userId          String
  role            String    @default("member") // "admin", "member"
  lastReadAt      DateTime?
  isMuted         Boolean   @default(false)
  joinedAt        DateTime  @default(now())
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id              String   @id @default(cuid())
  conversationId  String
  senderId        String
  content         String   @db.Text
  attachments     Json?    // Array of { type, url, name, size }
  isEdited        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// ==========================================
// Course Reviews & Ratings
// ==========================================

model CourseReview {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  rating    Int      // 1-5
  review    String?  @db.Text
  isHelpful Int      @default(0) // Number of helpful votes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, userId])
  @@index([courseId])
  @@map("course_reviews")
}

// ==========================================
// Certificates
// ==========================================

model Certificate {
  id              String   @id @default(cuid())
  uniqueId        String   @unique // Public verification ID
  userId          String
  courseId        String
  issuedAt        DateTime @default(now())
  grade           String?
  completionScore Float?
  templateId      String?
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("certificates")
}

// ==========================================
// Notifications
// ==========================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "enrollment", "message", "discussion", "announcement", "certificate"
  title     String
  content   String
  link      String?
  data      Json?    // Additional data for the notification
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

// ==========================================
// Course Announcements
// ==========================================

model CourseAnnouncement {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  content   String   @db.Text
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@index([courseId])
  @@map("course_announcements")
}

// ==========================================
// Lesson Progress Tracking
// ==========================================

model LessonProgress {
  id            String    @id @default(cuid())
  userId        String
  lessonId      String
  isCompleted   Boolean   @default(false)
  progressPct   Float     @default(0) // 0-100
  lastPosition  Int?      // Video playback position in seconds
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson        Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId])
  @@map("lesson_progress")
}